# Table of Contents

   * [Introduction](#introduction)
   * [Ansible Inventory](#ansible-inventory)
      * [Updating and retrieving the inventory](#updating-and-retrieving-the-inventory)
      * [Groups](#groups)
   * [Host management in Ansible](#host-management-in-ansible)
      * [Create a host](#create-a-host)
      * [Remove a host](#remove-a-host)
      * [Import a host](#import-a-host)
   * [Provision server](#provision-server)
   * [sec_host](#sec_host)
   * [k8s](#k8s)

# Introduction

This document describes the Ansible implementation in the Snowdrop project.

When in this document it refers to the `controller` it means the machine that executes the Ansible playbooks and roles and that owns the inventory, *i.e.*, the 
machine that clones this project.

The `hosts` are the machines where the playbooks and roles are executed against. 

The exception goes to the playbooks that are executed against `localhost`. This special host is referred to the `controller`. 

# Ansible Inventory

Ansible works against multiple systems in an infrastructure, called “hosts”, at the same time, using a list or group of lists know as inventory. 
Once the inventory is defined, you use patterns to select the hosts or groups you want Ansible to run against.

The inventory is comprised of several files and scripts based at the `k8s-infra/ansible/inventory` folder.

The inventory is built from the `passwordstore` project using the `pass_inventory.py` python script. This task is done automatically when Ansible is executed. 
For more information on the `passwordstore` project check gitlab.

More information on the Ansible Inventory and how to build it in the [Ansible User Guide](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html).

## Updating and retrieving the inventory

Because `passwordstore` is integrated with git, whenever a statement that changes any of the entries in the database is issued, a commit is automatically generated by pass itself.

With this in mind, whenever any statement that manages pass is executed, the corresponding `git push` must be manually issued by the user.

For information regarding retrieving the existing inventory to the local controller check [Import a host](#Import-a-host)

## Groups

Ansible hosts can be grouped into...well groups. This allows the execution of playbooks and the definition of variables in a common matter for different hosts. 

Host group assignment is made by adding folders and records to the passstore project, inside the  `/ansible/inventory`. Folders inside the inventory are considered 
 groups and records inside these folders are considered hosts in a structure like:
 
```text
+ --- ansible/inventory
       + --- group_1
       |     + host_1
       |     + host_2
       |     + host_3
       |
       + --- group_2
             + host_1
             + host_3
             + host_4
```

So if we want to define the ports that a k8s master should have open we can create a file named `masters` for instance in the `group_vars` folder and add there
every definition required such as:

```
firewalld_public_ports:
  - 6443/tcp
  - 10250/tcp
  - 10255/tcp
  - 8472/udp
  - 30000-32767/tcp
```

The assignment of hosts to groups is done in the passwordstore by adding an entry with the name of the host to a folder with the name of the group, regardless of it's content.

```bash
$ pass generate ansible/inventory/<group_name>/<host_name> 5
```

For instance, adding a host named `n01-k115` to the `k8s_115` group would be done the following way:

```bash
$ pass generate ansible/inventory/k8s_115/n01-k115 5
```

To remove the host from the group just remove the entry from the group folder as following...

```bash
$ pass rm ansible/inventory/<group_name>/<host_name>
```

For instance, to remove the previously added host:

```bash
$ pass generate ansible/inventory/k8s_115/n01-k115 5
```

# Host management in Ansible

The section describes how to maintain hosts in Ansible and their use. It's execution goes against the `controller`.

## Create a host

To create a host first the host must be added to the Ansible inventory. This is done using the following statement:

```bash
$ ansible-playbook ansible/playbook/passstore_controller_inventory.yml -e vm_name=<vm_name> -e pass_provider=<provider> --tag "create"
```

The VM name is the name that the host will have in the inventory and the provider is the cloud provider. 

> NOTE: ATTOW the only provider tested is `hetzner`. 

## Remove a host 

```bash
$ ansible-playbook ansible/playbook/passstore_controller_inventory_remove.yml -e vm_name=<vm_name> -e pass_provider=<provider>
```

> NOTE: ATTOW the only provider tested is `hetzner`. 

## Import a host

If a host has already been created it can be imported to the controller using:

```bash
$ ansible-playbook ansible/playbook/passstore_controller_inventory.yml -e vm_name=<vm_name> -e pass_provider=<provider>
```

It's the same as the previous statement but without the `create` *tag*.

# Provision server

Once the inventory is defined the server can be provisioned, if it isn't.

There should be different playbooks for each of the providers so check the corresponding provider:

* [Hetzner](../../hetzner/README-cloud.md)

Once the server is created it must be securized. More information on the next section.

# sec_host

This playbook executes several tasks regarding the security of hosts.

1. Updates all packages
1. Applies `sysctl` rules as described [here](https://linoxide.com/how-tos/linux-sysctl-tuning/)
    ```yaml
    # ignore ICMP packets (ping requests)
    net.ipv4.icmp_echo_ignore_all=1
    
    # This "sanity checking" helps against spoofing attack.
    net.ipv4.conf.all.rp_filter=1
    
    # Syn Flood protection
    net.ipv4.tcp_syncookies = 1
    ```
1. Sets the welcome message with proprietary information.
1. Changes default ssh port 
1. Installs lsof

The securization is executed using:

```bash
$  ansible-playbook ansible/playbook/sec_host.yml -e vm_name=<vm_name> -e provider=<provider>
```

Take into consideration that at the end of the securization the SSH port might be different that the default 22. This can be checked using:

```bash
$ pass show <path/to_host>/ansible_ssh_port
```

...such as...

```bash
$ pass show hetzner/my_host/ansible_ssh_port
```

# k8s

For information on k8s playbooks and roles check [here](../../kubernetes/README.md)