# Table of Contents

   * [Introduction](#introduction)
   * [Installation guide](#installation-guide)
   * [Ansible Inventory](#ansible-inventory)
      * [Updating and retrieving the inventory](#updating-and-retrieving-the-inventory)
      * [Groups](#groups)
   * [Host management in Ansible](#host-management-in-ansible)
      * [Create a host](#create-a-host)
      * [Remove a host](#remove-a-host)
      * [Import a host](#import-a-host)
   * [Provision server](#provision-server)
   * [sec_host](#sec_host)
   * [k8s](#k8s)

# Introduction

This document describes the Ansible implementation in the Snowdrop project.

When in this document it refers to the `controller` it means the machine that executes the Ansible playbooks and roles and that owns the inventory, *i.e.*, the 
machine that clones this project.

The `hosts` are the machines where the playbooks and roles are executed against. 

The exception goes to the playbooks that are executed against `localhost`. This special host is referred to the `controller`. 

# Installation guide

To install a fully functional project the following is required:

* Install Ansible version 2.8 or later
  * For more installation check the [Ansible Installation Guide](https://docs.ansible.com/ansible/latest/installation_guide/index.html)
  * Ansible uses Python, so check the Ansible [Python 3 Support](https://docs.ansible.com/ansible/latest/reference_appendices/python_3_support.html) page for more information.
* Install passwordstore
  * This project uses [pass](https://www.passwordstore.org/) to store passwords and certificates related to the project itself.
  * More information on installing pass in the Download section of the [passwordstore web page](https://www.passwordstore.org/)
* Clone the `passstore` project from GitLab.

> **NOTE**: Since passwordstore is integrated with [git](https://git-scm.com/), all changes made locally to a pass repository are automatically commited to the local git repo.
> Don't forget to `git push` and `git pull` often in order to have your local repository synchronized with other team members as well as publish to the team your changes. 

# Ansible Inventory

Ansible works against multiple systems in an infrastructure, called “hosts”, at the same time, using a list or group of lists know as inventory. 
Once the inventory is defined, you use patterns to select the hosts or groups you want Ansible to run against.

The inventory is comprised of several files and scripts based at the `k8s-infra/ansible/inventory` folder.

The inventory is built from the `passwordstore` project using the `pass_inventory.py` python script. This task is done automatically when Ansible is executed. 
For more information on the `passwordstore` project check gitlab.

More information on the Ansible Inventory and how to build it in the [Ansible User Guide](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html).

## Updating and retrieving the inventory

Because `passwordstore` is integrated with git, whenever a statement that changes any of the entries in the database is issued, a commit is automatically generated by pass itself.

With this in mind, whenever any statement that manages pass is executed, the corresponding `git push` must be manually issued by the user.

For information regarding retrieving the existing inventory to the local controller check [Import a host](#Import-a-host)

## Groups

Ansible hosts can be grouped into...well groups. This allows the execution of playbooks and the definition of variables in a common matter for different hosts.

Group definition is done inside the `ansible/inventory/hosts.yml` file using `yaml` format. In this file are the definitions of groups as well as the variable 
values assigned to each group. 

Host group assignment is made in `passstore` by managing entries in the `provider/host/groups` folder being each entry a group to which the host belongs. 

```text
+ --- provider
       + --- host_1
              + --- groups
                    |     + group_1
                    |     + group_2
                    |     + group_3
                    |
       + --- host_2
              + --- groups
                    |     + group_2
                    |     + group_3
```

For instance, we wanted to define the ports that a k8s master needs to open. This has been done in the `hosts.yml` file having the following varaible assigned to 
the `masters` group, which is also inside a group structure so other variables are inherited. 
  
```
firewalld_public_ports:
  - 6443/tcp
  - 10250/tcp
  - 10255/tcp
  - 8472/udp
  - 30000-32767/tcp
```

The assignment of hosts to groups is done in the passwordstore by adding an entry with the name of the group to the `groups` folder inside the hosts.

```bash
$ ansible-playbook ansible/playbook/passstore_manage_host_groups.yml -e operation=add -e group_name=<my_group> -e vm_name=<my_host>
```

For instance, adding a host named `n01-k115` to the `k8s_115` group would be done the following way:

```bash
$ ansible-playbook ansible/playbook/passstore_manage_host_groups.yml -e operation=add -e group_name=k8s_115 -e vm_name=n01-k115
```

To remove the host from the group just remove the entry from the group folder as following...

```bash
$ ansible-playbook ansible/playbook/passstore_manage_host_groups.yml -e operation=remove -e group_name=<my_group> -e vm_name=<my_host>
```

For instance, to undo the previous host operation:

```bash
$ ansible-playbook ansible/playbook/passstore_manage_host_groups.yml -e operation=remove -e group_name=k8s_115 -e vm_name=n01-k115
```

# Host management in Ansible

The section describes how to maintain hosts in Ansible and their use. It's execution goes against the `controller`.

## Create a host

To perform actions against a host, first the host must be added to the Ansible inventory. This is done using the following statement:

```bash
$ ansible-playbook ansible/playbook/passstore_controller_inventory.yml -e vm_name=<vm_name> -e pass_provider=<provider> --tag "create"
```

The VM name is the name that the host will have in the inventory and the provider is the cloud provider.

Additional information can be added so that the host is automatically added to k8s groups:

| Variable | Values | Description |
| --- | --- | --- | 
| vm_name |  | Name that will be assigned to the host, both in the Ansible inventory as well as in the actual host provider. |
| pass_provider | [hetzner] | Provider where the host will be installed |
| k8s_type | [maters,nodes] | Type of k8s host. |
| k8s_version | [115,116] | Version of k8s that will be installed in the host. |

> NOTE: ATTOW the only provider tested is `hetzner`. 

## Remove a host 

```bash
$ ansible-playbook ansible/playbook/passstore_controller_inventory_remove.yml -e vm_name=<vm_name> -e pass_provider=<provider>
```

> NOTE: ATTOW the only provider tested is `hetzner`. 

## Import a host

If a host has already been created it can be imported to the controller using:

```bash
$ ansible-playbook ansible/playbook/passstore_controller_inventory.yml -e vm_name=<vm_name> -e pass_provider=<provider>
```

It's the same as the previous statement but without the `create` *tag*.

# Provision server

Once the inventory is defined the server can be provisioned, if it isn't.

There should be different playbooks for each of the providers so check the corresponding provider:

* [Hetzner](../../hetzner/README-cloud.md)

Once the server is created it must be securized. More information on the next section.

# sec_host

This playbook executes several tasks regarding the security of hosts.

1. Updates all packages
1. Applies `sysctl` rules as described [here](https://linoxide.com/how-tos/linux-sysctl-tuning/)
    ```yaml
    # ignore ICMP packets (ping requests)
    net.ipv4.icmp_echo_ignore_all=1
    
    # This "sanity checking" helps against spoofing attack.
    net.ipv4.conf.all.rp_filter=1
    
    # Syn Flood protection
    net.ipv4.tcp_syncookies = 1
    ```
1. Sets the welcome message with proprietary information.
1. Changes default ssh port 
1. Installs lsof

The securization is executed using:

```bash
$  ansible-playbook ansible/playbook/sec_host.yml -e vm_name=<vm_name> -e provider=<provider>
```

Take into consideration that at the end of the securization the SSH port might be different that the default 22. This can be checked using:

```bash
$ pass show <path/to_host>/ansible_ssh_port
```

...such as...

```bash
$ pass show hetzner/my_host/ansible_ssh_port
```

# k8s

For information on k8s playbooks and roles check [here](../../kubernetes/README.md)

# Playbooks

## `passstore_controller_inventory` and `passstore_controller_inventory_remove`

These playbooks add and remove a host to the ansible inventory located in the passstore project.