- name: Install Dashboard
  shell: |
    kubectl --kubeconfig=$HOME/.kube/config \
      apply -f \
      https://raw.githubusercontent.com/kubernetes/dashboard/{{ k8s_dashboard_version }}/aio/deploy/recommended.yaml

- name: Copy Template files
  template:
    src: "{{ item }}"
    dest: "/tmp/{{ item | basename | regex_replace('.j2','') }}"
  with_fileglob:
    - "../templates/*.j2"

- name: Create the Service Account, ClusterRoleBinding for the K8s Dashboard admin-user like also the Ingress route
  shell: |
    kubectl --kubeconfig=$HOME/.kube/config apply -f /tmp/serviceaccount-clusterrolebinding.yml
    kubectl --kubeconfig=$HOME/.kube/config apply -f /tmp/ingress-dashboard.yml

- name: Get K8s Dashboard token from the admin-user secret
  shell: |
    secretname=$(kubectl --kubeconfig=$HOME/.kube/config -n {{ k8s_dashboard_namespace }} get serviceaccount admin-user -o jsonpath='{.secrets[0].name}')
    kubectl --kubeconfig=$HOME/.kube/config -n {{ k8s_dashboard_namespace }} get secret $secretname -o template -o jsonpath='{.data.token}' | base64 --decode
  register: get_token_out

- set_fact:
    k8s_token: "{{ get_token_out.stdout }}"

- name: Print kubernetes dashboard URL & Token
  debug:
    msg:
      - "You can also view the kubernetes dashboard at"
      - "http://k8s-console.{{ k8s_dashboard_ingress_host }}/"
      - ""
      - "Using the Token: "
      - "{{ k8s_token }}"
